"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Path = require("path");
const Util = require("./Util");
const Jake = require("./Jake");
const Command_1 = require("./Command");
let RawExec = Util.CreateNodeExec("browserify", "browserify --help", "browserify/bin/cmd.js");
let Tsify = "tsify";
Tsify = Util.FindModulePath(Tsify) || Tsify;
let Collapser = "bundle-collapser/plugin.js";
Collapser = Util.FindModulePath(Collapser) || Collapser;
function Exec(inputs, output, callback, isRelease, tsargs, options, isSilent) {
    let args = inputs;
    if (tsargs !== null) {
        args += " -p [ " + Tsify + " --global " + (tsargs || "") + " ]";
    }
    if (isRelease) {
        args += "  -p [ " + Collapser + " ]";
    }
    else {
        args += " --debug";
    }
    args += " --outfile " + output;
    if (options) {
        args += " " + options;
    }
    Jake.Shell.mkdir("-p", Path.dirname(output));
    RawExec(args, callback, isSilent);
}
exports.Exec = Exec;
function BrowserifyTask(name, dependencies, output, inputs, isRelease, tsargs, options) {
    let depInfo = new Command_1.CommandInfo({
        Name: name,
        Dir: Path.resolve(Util.LocalDir),
        Output: output,
        Inputs: inputs,
        IsRelease: isRelease,
        Tsargs: tsargs,
        Options: options,
        Dependencies: dependencies
    });
    file(depInfo.DependencyFile, depInfo.AllDependencies, function () {
        Exec(inputs, output, (error, stdout, stderror) => {
            Command_1.ExtractFilesAndUpdateDependencyInfo(depInfo, error, stdout, stderror);
            this.complete();
            Jake.LogTask(this, 2);
        }, isRelease, tsargs, (options || "") + " --list", true);
    }, { async: true });
    file(output, [depInfo.DependencyFile], function () {
        Exec(inputs, output, () => {
            this.complete();
            Jake.LogTask(this, 2);
        }, isRelease, tsargs, options);
    }, { async: true });
    return output;
}
exports.BrowserifyTask = BrowserifyTask;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnJvd3NlcmlmeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkJyb3dzZXJpZnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsK0JBQStCO0FBQy9CLCtCQUErQjtBQUMvQix1Q0FBNkU7QUFFN0UsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FDL0IsWUFBWSxFQUNaLG1CQUFtQixFQUNuQix1QkFBdUIsQ0FDeEIsQ0FBQztBQUVGLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQztBQUNwQixLQUFLLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUM7QUFFNUMsSUFBSSxTQUFTLEdBQUcsNEJBQTRCLENBQUM7QUFDN0MsU0FBUyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLElBQUksU0FBUyxDQUFDO0FBRXhELGNBQXFCLE1BQWMsRUFBRSxNQUFjLEVBQUUsUUFBUSxFQUFFLFNBQW1CLEVBQUUsTUFBZSxFQUFFLE9BQWdCLEVBQUUsUUFBa0I7SUFDdkksSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDO0lBQ2xCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3BCLElBQUksSUFBSSxRQUFRLEdBQUcsS0FBSyxHQUFHLFlBQVksR0FBRyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDbEUsQ0FBQztJQUNELEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDZCxJQUFJLElBQUksU0FBUyxHQUFHLFNBQVMsR0FBRyxJQUFJLENBQUM7SUFDdkMsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sSUFBSSxJQUFJLFVBQVUsQ0FBQztJQUNyQixDQUFDO0lBQ0QsSUFBSSxJQUFJLGFBQWEsR0FBRyxNQUFNLENBQUM7SUFDL0IsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUNaLElBQUksSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDO0lBQ3hCLENBQUM7SUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBRTdDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQ3BDLENBQUM7QUFsQkQsb0JBa0JDO0FBRUQsd0JBQ0UsSUFBWSxFQUNWLFlBQXNCLEVBQ3RCLE1BQWMsRUFDZCxNQUFjLEVBQ2QsU0FBbUIsRUFDbkIsTUFBZSxFQUNmLE9BQWdCO0lBRWxCLElBQUksT0FBTyxHQUFHLElBQUkscUJBQVcsQ0FBQztRQUM1QixJQUFJLEVBQUUsSUFBSTtRQUNWLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDaEMsTUFBTSxFQUFFLE1BQU07UUFDZCxNQUFNLEVBQUUsTUFBTTtRQUNkLFNBQVMsRUFBRSxTQUFTO1FBQ3BCLE1BQU0sRUFBRSxNQUFNO1FBQ2QsT0FBTyxFQUFFLE9BQU87UUFDaEIsWUFBWSxFQUFFLFlBQVk7S0FDM0IsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsT0FBTyxDQUFDLGVBQWUsRUFBRTtRQUNwRCxJQUFJLENBQ0YsTUFBTSxFQUNKLE1BQU0sRUFDTixDQUFDLEtBQUssRUFBRSxNQUFjLEVBQUUsUUFBUTtZQUNoQyw2Q0FBbUMsQ0FBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQztZQUN0RSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDaEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDeEIsQ0FBQyxFQUNDLFNBQVMsRUFDVCxNQUFNLEVBQ04sQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDLEdBQUcsU0FBUyxFQUMzQixJQUFJLENBQ1AsQ0FBQztJQUNKLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBRXBCLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEVBQUU7UUFDckMsSUFBSSxDQUNGLE1BQU0sRUFDSixNQUFNLEVBQ047WUFDQSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDaEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDeEIsQ0FBQyxFQUNDLFNBQVMsRUFDVCxNQUFNLEVBQ04sT0FBTyxDQUNWLENBQUM7SUFDSixDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUVwQixNQUFNLENBQUMsTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFuREQsd0NBbURDIn0=